/*! DocHub Attachments UI (PDF, multi, modal) */
!function(){const t=document,e=(window,(e,n=t)=>Array.from((n||t).querySelectorAll(e))),n=(e,n=t)=>(n||t).querySelector(e);function a(){if(n("#attachmentsModal"))return;const e=t.createElement("div");e.innerHTML='\n        <div class="modal fade" id="attachmentsModal" tabindex="-1" aria-hidden="true">\n            <div class="modal-dialog modal-lg modal-dialog-scrollable">\n            <div class="modal-content">\n                <div class="modal-header">\n                <h5 class="modal-title">Attachments</h5>\n                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>\n                </div>\n                <div class="modal-body">\n                <div class="mb-3 dropzone" id="att-drop">Drag & drop PDF here or <label class="link-primary" style="cursor:pointer"><input id="att-file" type="file" accept="application/pdf" multiple hidden>choose files</label></div>\n                <div id="att-list"></div>\n                </div>\n                <div class="modal-footer">\n                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>\n                </div>\n            </div>\n            </div>\n        </div>\n        <div class="modal fade" id="pdfViewerModal" tabindex="-1" aria-hidden="true">\n            <div class="modal-dialog modal-xl modal-dialog-centered">\n            <div class="modal-content">\n                <div class="modal-header">\n                <h5 class="modal-title p-2" id="pdfTitle">PDF</h5>\n                <a id="pdfOpen" class="btn btn-sm btn-outline-primary" target="_blank" rel="noopener">Open in new tab</a>\n                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>\n                </div>\n                <div class="modal-body p-0" id="pdfContainer">\n                \x3c!-- Object element will be created dynamically here --\x3e\n                </div>\n            </div>\n            </div>\n        </div>',t.body.append(e)}let d=null,o=null,i=null;function s(){return window.bootstrap||window.mdb||null}async function l(){const e=n("#att-list");e.innerHTML="";const a=await(window.AttachmentsDB?.list(d)||Promise.resolve([]));if(!a.length)return e.innerHTML='<div class="text-muted">No attachments yet.</div>',void c(d,0);const o=t.createDocumentFragment();a.forEach(e=>{const n=t.createElement("div");n.className="file-row",n.innerHTML=`\n                <div class="meta">\n                    <div class="name">${e.name}</div>\n                    <div class="sub">${(t=>{const e=["B","KB","MB","GB"];let n=0,a=t||0;for(;a>=1024&&n<e.length-1;)a/=1024,n++;return Math.round(10*a)/10+" "+e[n]})(e.size)} â€¢ ${new Date(e.addedAt).toLocaleString()}</div>\n                </div>\n                <div class="btn-group">\n                    <button class="btn btn-sm btn-outline-primary" data-view="${e.id}">View</button>\n                    <button class="btn btn-sm btn-outline-danger" data-del="${e.id}">Delete</button>\n                </div>`,o.append(n)}),e.append(o),c(d,a.length)}function c(t,n){e(`.attachments-btn[data-doc="${CSS.escape(t)}"] .count-badge`).forEach(t=>t.textContent=n)}function r(){e("[data-doc-id],[data-id],.doc-card").forEach(t=>{const e=function(t){return t?.dataset?.docId||t?.dataset?.id||t?.getAttribute("data-id")||null}(t);if(!e)return;if(t.querySelector(`.attachments-btn[data-doc="${CSS.escape(e)}"]`))return;let i=t.querySelector(".doc-actions");i||(i=document.createElement("div"),i.className="doc-actions",i.style.display="inline-flex",i.style.gap=".25rem",t.prepend(i));const r=document.createElement("button");r.type="button",r.className="btn btn-outline-secondary btn-sm attachments-btn",r.setAttribute("data-doc",e),r.innerHTML='ðŸ“Ž <span class="count-badge">0</span>',r.addEventListener("click",()=>{const i=(t.querySelector(".doc-title,.card-title")||{}).textContent||"";!function(t,e){d=t,a();const i=s();o=o||i&&new i.Modal(n("#attachmentsModal")),o?(n("#attachmentsModal .modal-title").textContent=`Attachments â€” ${e||""}`,l(),o.show()):alert("Bootstrap modal not available.")}(e,i)}),i.append(r),window.AttachmentsDB.list(e).then(t=>c(e,t.length))})}function m(){window.AttachmentsDB?(a(),function(){const t=n("#att-drop"),e=n("#att-file");if(!t||!e)return;const a=t=>{const e=Array.from(t||[]).filter(t=>(t.type||"application/pdf").includes("pdf"));e.length&&Promise.all(e.map(t=>window.AttachmentsDB.add(d,t))).then(l)};t.addEventListener("dragover",e=>{e.preventDefault(),t.classList.add("dragover")}),t.addEventListener("dragleave",()=>t.classList.remove("dragover")),t.addEventListener("drop",e=>{e.preventDefault(),t.classList.remove("dragover"),a(e.dataTransfer.files)}),e.addEventListener("change",t=>a(t.target.files))}(),n("#att-list").addEventListener("click",async t=>{const e=t.target.closest("[data-view]"),o=t.target.closest("[data-del]");if(e){const t=e.getAttribute("data-view"),o=await window.AttachmentsDB.getUrl(d,t);if(!o)return void alert("File missing");a();const l=s();i=i||l&&new l.Modal(n("#pdfViewerModal"));const c=n("#pdfContainer");c.innerHTML="";const r=document.createElement("object");r.id="pdfEmbed",r.className="pdf-embed",r.type="application/pdf",r.setAttribute("data",o),c.appendChild(r),n("#pdfTitle").textContent=e.parentElement.parentElement.querySelector(".name").textContent,n("#pdfOpen").href=o,i.show()}if(o){const t=o.getAttribute("data-del");confirm("Delete this attachment?")&&(await window.AttachmentsDB.remove(d,t),l())}}),r(),new MutationObserver(()=>r()).observe(t.body,{childList:!0,subtree:!0})):console.error("AttachmentsDB not found. Include attachments-db.js first.")}"loading"===t.readyState?t.addEventListener("DOMContentLoaded",m,{once:!0}):m()}();