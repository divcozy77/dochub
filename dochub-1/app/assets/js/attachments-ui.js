/*! DocHub Attachments UI (PDF, multi, modal) */
!function(){const t=document,e=(window,(e,n=t)=>Array.from((n||t).querySelectorAll(e))),n=(e,n=t)=>(n||t).querySelector(e);new WeakSet;function a(){if(n("#attachmentsModal"))return;const e=t.createElement("div");e.innerHTML='\n<div class="modal fade" id="attachmentsModal" tabindex="-1" aria-hidden="true">\n  <div class="modal-dialog modal-lg modal-dialog-scrollable">\n    <div class="modal-content">\n      <div class="modal-header">\n        <h5 class="modal-title">Attachments</h5>\n        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>\n      </div>\n      <div class="modal-body">\n        <div class="mb-3 dropzone" id="att-drop">\n          Drag & drop PDF here or\n          <label class="link-primary" style="cursor:pointer">\n            <input id="att-file" type="file" accept="application/pdf" multiple hidden>choose files\n          </label>\n        </div>\n        <div id="att-list"></div>\n      </div>\n      <div class="modal-footer">\n        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>\n      </div>\n    </div>\n  </div>\n</div>\n<div class="modal fade" id="pdfViewerModal" tabindex="-1" aria-hidden="true">\n  <div class="modal-dialog modal-xl modal-dialog-centered">\n    <div class="modal-content">\n      <div class="modal-header">\n        <h5 class="modal-title p-2" id="pdfTitle">PDF</h5>\n        <a id="pdfOpen" class="btn btn-sm btn-outline-primary" target="_blank" rel="noopener">Open in new tab</a>\n        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>\n      </div>\n      <div class="modal-body p-0" id="pdfContainer">\n        \x3c!-- Object element will be created dynamically here --\x3e\n      </div>\n    </div>\n  </div>\n</div>',t.body.append(e)}let d=null,i=null,o=null,s=null;function l(){return window.bootstrap||window.mdb||null}async function r(){const e=n("#att-list");e.innerHTML="";const a=await(window.AttachmentsDB?.list(d)||Promise.resolve([]));if(!a.length)return e.innerHTML='<div class="text-muted">No attachments yet.</div>',void c(d,0);const i=t.createDocumentFragment();a.forEach(e=>{const n=t.createElement("div");n.className="file-row",n.innerHTML=`\n        <div class="meta">\n          <div class="name">${e.name}</div>\n          <div class="sub">${(t=>{const e=["B","KB","MB","GB"];let n=0,a=t||0;for(;a>=1024&&n<e.length-1;)a/=1024,n++;return Math.round(10*a)/10+" "+e[n]})(e.size)} â€¢ ${new Date(e.addedAt).toLocaleString()}</div>\n        </div>\n        <div class="btn-group">\n          <button class="btn btn-sm btn-outline-primary" data-view="${e.id}"><i class="fas fa-eye me-1"></i>View</button>\n          <button class="btn btn-sm btn-outline-secondary" data-open="${e.id}"><i class="fas fa-external-link-alt me-1"></i>Open</button>\n          <button class="btn btn-sm btn-outline-danger" data-del="${e.id}">Delete</button>\n        </div>`,i.append(n)}),e.append(i),c(d,a.length)}function c(t,n){e(`.attachments-btn[data-doc="${CSS.escape(t)}"] .count-badge`).forEach(t=>t.textContent=n)}function m(){e("[data-doc-id],[data-id],.doc-card").forEach(t=>{if(t.closest(".modal"))return;let e=t.querySelector(".doc-actions");if(!e)return;const o=function(t){return t?.dataset?.docId||t?.dataset?.id||t?.getAttribute("data-id")||null}(t);if(o&&!t.querySelector(`.attachments-btn[data-doc="${CSS.escape(o)}"]`)&&e){const s=document.createElement("button");s.type="button",s.className="btn btn-outline-secondary btn-sm attachments-btn",s.setAttribute("data-doc",o),s.innerHTML='ðŸ“Ž <span class="count-badge">0</span>',s.addEventListener("click",()=>{const e=(t.querySelector(".doc-title,.card-title")||{}).textContent||"";!function(t,e){d=t,a();const o=l();i=i||o&&new o.Modal(n("#attachmentsModal")),i?(n("#attachmentsModal .modal-title").textContent=`Attachments â€” ${e||""}`,r(),i.show()):alert("Bootstrap modal not available.")}(o,e)}),e.append(s),window.AttachmentsDB.list(o).then(t=>c(o,t.length))}})}function b(){window.AttachmentsDB?(a(),function(){const t=n("#att-drop"),e=n("#att-file");if(!t||!e)return;const a=t=>{const e=Array.from(t||[]).filter(t=>(t.type||"application/pdf").includes("pdf"));e.length&&Promise.all(e.map(t=>window.AttachmentsDB.add(d,t))).then(r)};t.addEventListener("dragover",e=>{e.preventDefault(),t.classList.add("dragover")}),t.addEventListener("dragleave",()=>t.classList.remove("dragover")),t.addEventListener("drop",e=>{e.preventDefault(),t.classList.remove("dragover"),a(e.dataTransfer.files)}),e.addEventListener("change",t=>a(t.target.files))}(),n("#att-list").addEventListener("click",async t=>{const e=t.target.closest("[data-view]"),i=t.target.closest("[data-open]"),c=t.target.closest("[data-del]");if(e){const t=e.getAttribute("data-view"),i=await window.AttachmentsDB.getUrl(d,t);if(!i)return void alert("File missing");a();const r=l();if(o=o||r&&new r.Modal(n("#pdfViewerModal")),s&&String(s).startsWith("blob:"))try{URL.revokeObjectURL(s)}catch{}s=i;const c=n("#pdfContainer");c.innerHTML="";const m=document.createElement("object");m.id="pdfEmbed",m.className="pdf-embed",m.type="application/pdf";const b="string"!=typeof i||i.startsWith("blob:")?i:i+(i.includes("?")?"&":"?")+"v="+Date.now();m.setAttribute("data",b),m.style.width="100%",m.style.height="calc(92vh - 56px)",m.setAttribute("aria-label","PDF preview"),c.appendChild(m),n("#pdfTitle").textContent=e.parentElement.parentElement.querySelector(".name").textContent,n("#pdfOpen").href=b,o.show()}if(i){const t=i.getAttribute("data-open"),e=await window.AttachmentsDB.getUrl(d,t);if(!e)return void alert("File missing");window.open(e,"_blank")}if(c){const t=c.getAttribute("data-del");confirm("Delete this attachment?")&&(await window.AttachmentsDB.remove(d,t),r())}}),m(),new MutationObserver(()=>m()).observe(t.body,{childList:!0,subtree:!0}),t.addEventListener("hidden.bs.modal",t=>{if(t.target&&"pdfViewerModal"===t.target.id){if(s&&String(s).startsWith("blob:"))try{URL.revokeObjectURL(s)}catch{}s=null;const t=n("#pdfContainer");t&&(t.innerHTML="")}})):console.error("AttachmentsDB not found. Include attachments-db.js first.")}"loading"===t.readyState?t.addEventListener("DOMContentLoaded",b,{once:!0}):b()}();